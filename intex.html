document.addEventListener("DOMContentLoaded", function () {
    const terminal = document.getElementById("terminal-output");
    const inputField = document.getElementById("user-input");
    const titleBar = document.getElementById("title-bar");

    let history = [];
    let historyIndex = 0;

    function logOutput(text, delay = 100) {
        setTimeout(() => {
            let newLine = document.createElement("div");
            newLine.classList.add("output-line");
            newLine.innerHTML = `> ${text}`;
            terminal.appendChild(newLine);
            terminal.scrollTop = terminal.scrollHeight;
        }, delay);
    }

    function playSound(soundId) {
        document.getElementById(soundId).play();
    }

    function glitchTitle() {
        const originalText = "7Hâˆ‘ 5Â¥5â€ âˆ‘M 15 FÎ›1L1Î G...";
        const glitchVariants = [
            "7Hâˆ‘ 5Â¥5â€ âˆ‘M 15 ...",
            "7Hâˆ‘ ??? 15 FÎ›1L1Î G",
            "### ### ## ######",
            "?????? ???????",
            "âˆ‘Â¥5â€ âˆ‘M ERR0R 404"
        ];
        titleBar.innerText = glitchVariants[Math.floor(Math.random() * glitchVariants.length)];
        setTimeout(() => {
            titleBar.innerText = originalText;
        }, 1000);
    }

    function screenFlicker() {
        document.body.classList.add("flash");
        setTimeout(() => {
            document.body.classList.remove("flash");
        }, 500);
    }

    function injectRandomGlitch() {
        if (Math.random() < 0.2) {
            logOutput("[SYSTEM ERROR] Unknown process detected.");
            playSound("glitch-sound");
        }
        if (Math.random() < 0.1) {
            logOutput("â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ");
            screenFlicker();
        }
        if (Math.random() < 0.05) {
            playSound("error-sound");
            logOutput("WARNING: Intrusion detected.");
        }
    }

    function handleInput(command) {
        if (!command.trim()) return;
        history.push(command);
        historyIndex = history.length;
        logOutput(command);
        processCommand(command.toLowerCase());
    }

    function processCommand(cmd) {
        switch (cmd) {
            case "help":
                logOutput("Commands: HELP, SCAN, TRACE, INFILTRATE, EXIT");
                break;
            case "scan":
                logOutput("Running deep network scan...\\n[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 78%\\nThreat detected.");
                break;
            case "trace":
                logOutput("Tracing hostile activity...\\nWarning: Signal compromised.");
                screenFlicker();
                break;
            case "infiltrate":
                logOutput("Bypassing security protocols...\\nFirewall encountered.\\nSystem response: \\\"WHO ARE YOU?\\\"");
                playSound("malware-sound");
                break;
            case "exit":
                logOutput("You can never leave.", 300);
                setTimeout(() => {
                    document.body.style.background = "#ff0000";
                }, 1000);
                break;
            default:
                logOutput("Unknown command. System anomaly detected.");
                playSound("glitch-sound");
                break;
        }
    }

    document.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            let command = inputField.innerText.trim();
            if (command) {
                handleInput(command);
                inputField.innerText = "";
            }
        } else if (event.key === "ArrowUp") {
            if (historyIndex > 0) {
                historyIndex--;
                inputField.innerText = history[historyIndex];
            }
        } else if (event.key === "ArrowDown") {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                inputField.innerText = history[historyIndex];
            } else {
                inputField.innerText = "";
            }
        }
    });

    // ðŸ”¥ SYSTEM RANDOM EVENTS ðŸ”¥
    setInterval(() => {
        glitchTitle();
        injectRandomGlitch();
    }, Math.random() * 10000 + 5000); // Random every 5-15 sec

    logOutput("Initializing Sentinel // Black Echo...");
    setTimeout(() => logOutput("Connection unstable. Proceed at your own risk."), 1500);
});
